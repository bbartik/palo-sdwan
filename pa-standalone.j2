{# Standalone PAN-OS Configuration Template #}
{# This template generates CLI "set" commands for direct firewall configuration #}
{# (No Panorama template wrapper) #}

{% if vars.role == "hub" %}
{%  set remote_zone = "zone-to-branch" %}
{% elif vars.role == "branch" %}
{%  set remote_zone = "zone-to-hub" %}
{% endif %}

{# Device description #}
set deviceconfig system hostname {{ vars.name }}


{# SDWAN Interface Profiles #}
{% for profile, v in vars.profiles.items()%}
set tag {{ v.tag }} color color1
set sdwan-interface-profile {{ profile }} link-tag {{ v.tag }}
set sdwan-interface-profile {{ profile }} link-type {{ v.type }}
set sdwan-interface-profile {{ profile }} maximum-download {{ v.download }}
set sdwan-interface-profile {{ profile }} maximum-upload {{ v.upload }}
set sdwan-interface-profile {{ profile }} path-monitoring Aggressive
set sdwan-interface-profile {{ profile }} probe-frequency 5
set sdwan-interface-profile {{ profile }} failback-hold-time 120
set sdwan-interface-profile {{ profile }} vpn-data-tunnel-support {{ v.tunnel }}
{%- endfor %}

{# Interface Management Profiles #}
set network profiles interface-management-profile ping-only ping yes
set network profiles interface-management-profile check_ping ping yes
set network profiles monitor-profile sdwan-default

{# Physical Interfaces #}
{%- for intf, i in vars.interfaces.items()%}
{%  if i.sdwan_gw is defined %}
set network interface ethernet {{ i.name }} layer3 ip {{ i.address }} sdwan-gateway {{ i.sdwan_gw }}
set network interface ethernet {{ i.name }} layer3 sdwan-link-settings enable yes
set import network interface [ {{ i.name }} ]
set network interface ethernet {{ i.name }} layer3 sdwan-link-settings sdwan-interface-profile {{ i.sdwan_profile }}
{%  else %}
set network interface ethernet {{ i.name }} layer3 ip {{ i.address}}
set import network interface [ {{ i.name }} ]
{%  endif -%}
set network interface ethernet {{ i.name }} layer3 interface-management-profile ping-only
set network interface ethernet {{ i.name }} comment {{ intf }}
set zone {{ i.zone }} network layer3 {{ i.name }}
set network virtual-router default interface {{ i.name }}
{%- endfor %}

{# Loopback Interface #}
set network interface loopback units loopback.1 ip {{ vars.loopback }}/32
set import network interface [ loopback.1 ]
set network interface loopback units loopback.1 interface-management-profile ping-only
set zone zone-internal network layer3 loopback.1
set network virtual-router default interface loopback.1

{# Remote Sites - SDWAN Interfaces and Tunnels #}
{% for branch, b in vars.remotes.items() %}
set network interface sdwan units sdwan.{{ b.sdwan_intf }}
set import network interface [ sdwan.{{ b.sdwan_intf }} ]
set zone {{ remote_zone }} network layer3 sdwan.{{ b.sdwan_intf }}
set network virtual-router default interface sdwan.{{ b.sdwan_intf }}
{%  for tunnel, t in b.tunnels.items() %}
set network ike gateway {{ tunnel }} authentication pre-shared-key key -AQ==zPJb3ngM1sGjXlfX2+Qk6rbdv1I=ucInIpBmFcnkQK7zF4VO1w==
set network ike gateway {{ tunnel }} protocol version ikev2
set network ike gateway {{ tunnel }} local-address interface {{ t.local_intf }} ip {{ t.local_ip }}
set network ike gateway {{ tunnel }} peer-address ip {{ t.peer_ip }}
set network interface tunnel units {{ t.intf }} ip {{ t.ip }}
set network interface tunnel units {{ t.intf }} interface-management-profile ping-only
set import network interface [ {{ t.intf }} ]
set network virtual-router default interface [ {{ t.intf }} ]
set zone {{ remote_zone }} network layer3 [ {{ t.intf }} ]
set network tunnel ipsec {{ tunnel }} auto-key ike-gateway {{ tunnel }}
set network tunnel ipsec {{ tunnel }} tunnel-interface {{ t.intf }}
set network tunnel ipsec {{ tunnel }} tunnel-monitor destination-ip {{ t.monitor_ip}}
set network tunnel ipsec {{ tunnel }} tunnel-monitor tunnel-monitor-profile sdwan-default
set network tunnel ipsec {{ tunnel }} tunnel-monitor enable yes
set network interface sdwan units sdwan.{{ b.sdwan_intf }} interface [ {{ t.intf }} ]
{%  endfor %}
set network virtual-router default routing-table ip static-route {{ branch }}_loopback destination {{ b.loopback }}/32 interface sdwan.{{ b.sdwan_intf}}
{%  if remote_wans is defined %}
{%-  for w, nh in b.remote_wans.items() %}
set network virtual-router default routing-table ip static-route {{ branch }}_wan destination {{ w }} interface {{ nh.intf }} nexthop ip-address {{ nh.gw }}
{%-  endfor %}
{%  endif %}
{% endfor %}

{# BGP Configuration #}
set network virtual-router default protocol redist-profile connected filter type connect
set network virtual-router default protocol redist-profile connected priority 1
set network virtual-router default protocol redist-profile connected action redist
set network virtual-router default protocol bgp router-id {{ vars.loopback }}
set network virtual-router default protocol bgp local-as {{ vars.asn }}
set network virtual-router default protocol bgp enable yes
set network virtual-router default protocol bgp install-route yes
{%- for branch, b in vars.remotes.items() %}
set network virtual-router default protocol bgp peer-group {{ branch }}_pg peer {{ branch }} peer-address ip {{ b.loopback }}
set network virtual-router default protocol bgp peer-group {{ branch }}_pg peer {{ branch }} local-address ip {{ vars.loopback }}/32
set network virtual-router default protocol bgp peer-group {{ branch }}_pg peer {{ branch }} local-address interface loopback.1
set network virtual-router default protocol bgp peer-group {{ branch }}_pg peer {{ branch }} peer-as {{ 65000 + b.id }}
{%- endfor %}
set network virtual-router default protocol bgp redist-rules connected enable yes
set network virtual-router default protocol bgp redist-rules connected address-family-identifier ipv4
{% if vars.role == "hub" %}
set network virtual-router default protocol bgp policy aggregation address corp_summary prefix {{ prefix|default("192.168.0.0/16") }}
set network virtual-router default protocol bgp policy aggregation address corp_summary summary yes
{%- endif %}

{# Security Policies #}
set rulebase security rules allow-bgp from zone-internal
set rulebase security rules allow-bgp from {{ remote_zone }}
set rulebase security rules allow-bgp to zone-internal
set rulebase security rules allow-bgp to {{ remote_zone }}
set rulebase security rules allow-bgp source any
set rulebase security rules allow-bgp destination any
set rulebase security rules allow-bgp application bgp
set rulebase security rules allow-bgp service application-default
set rulebase security rules allow-bgp action allow

set rulebase security rules allow-icmp from zone-internal
set rulebase security rules allow-icmp from {{ remote_zone }}
set rulebase security rules allow-icmp to zone-internal
set rulebase security rules allow-icmp to {{ remote_zone }}
set rulebase security rules allow-icmp source any
set rulebase security rules allow-icmp destination any
set rulebase security rules allow-icmp application ping
set rulebase security rules allow-icmp service application-default
set rulebase security rules allow-icmp action allow

{# NAT Rules for each ISP interface #}
{%- for intf, i in vars.interfaces.items()%}
{%- if "isp" in intf %}
set rulebase nat rules nat_{{ intf }} from zone-internal
set rulebase nat rules nat_{{ intf }} to {{ i.zone }}
set rulebase nat rules nat_{{ intf }} source any
set rulebase nat rules nat_{{ intf }} destination any
set rulebase nat rules nat_{{ intf }} service any
set rulebase nat rules nat_{{ intf }} to-interface {{ i.name }}
set rulebase nat rules nat_{{ intf }} source-translation dynamic-ip-and-port interface-address interface {{ i.name }}
{%- endif %}
{%- endfor %}

{# SDWAN Bundle for native ISP interfaces #}
set network interface sdwan units sdwan.1
set import network interface [ sdwan.1 ]
set zone zone-internet network layer3 sdwan.1
set network virtual-router default interface sdwan.1
{%- for intf, i in vars.interfaces.items()%}
{%- if "isp" in intf %}
set network interface sdwan units sdwan.1 interface [ {{ i.name }} ]
{%- endif %}
{%- endfor %}

{# Default Routes and LAN Redistribution #}
{# Main default route via SDWAN bundle #}
set network virtual-router default routing-table ip static-route default destination 0.0.0.0/0 interface sdwan.1
set network virtual-router default routing-table ip static-route default metric 10
{# Backup routes via individual ISP interfaces #}
{%- set isp_count = namespace(n=1) %}
{%- for intf, i in vars.interfaces.items()%}
{%- if "isp" in intf %}
set network virtual-router default routing-table ip static-route default_{{ intf.split("isp")[1] }} destination 0.0.0.0/0 interface {{ i.name }} nexthop ip-address {{ i.sdwan_gw }}
set network virtual-router default routing-table ip static-route default_{{ intf.split("isp")[1] }} metric {{ 100 + isp_count.n }}
{%- set isp_count.n = isp_count.n + 1 %}
{%- endif %}
{%- if "lan" in intf %}
set network virtual-router default protocol redist-profile connected filter interface {{ i.name }}
{%- endif %}
{%- endfor %}
